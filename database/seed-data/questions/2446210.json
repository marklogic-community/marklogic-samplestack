{
  "id": "/questions/2446210",
  "creationDate": "2014-03-17T17:53:27.520",
  "body": "\n\nI'm getting started with FubuMVC and I have a simple Customer -> Order relationship I'm trying to display using nested partials.  My domain objects are as follows:\n\n\tpublic class Customer\n\t{\n\t    private readonly IList<Order> orders = new List<Order>();\n\t\n\t    public string Name { get; set; }\n\t    public IEnumerable<Order> Orders\n\t    {\n\t        get { return orders; }\n\t    }\n\t\n\t    public void AddOrder(Order order)\n\t    {\n\t        orders.Add(order);\n\t    }\n\t}\n\t\n\tpublic class Order\n\t{\n\t    public string Reference { get; set; }\n\t}\n\t\n\nI have the following controller classes:\n\n\tpublic class CustomersController\n\t{\n\t    public IndexViewModel Index(IndexInputModel inputModel)\n\t    {\n\t        var customer1 = new Customer { Name = \"John Smith\" };\n\t        customer1.AddOrder(new Order { Reference = \"ABC123\" });\n\t\n\t        return new IndexViewModel { Customers = new[] { customer1 } };\n\t    }\n\t}\n\t\n\tpublic class IndexInputModel\n\t{\n\t}\n\t\n\tpublic class IndexViewModel\n\t{\n\t    public IEnumerable<Customer> Customers { get; set; }\n\t}\n\t\n\tpublic class IndexView : FubuPage<IndexViewModel>\n\t{\n\t}\n\t\n\tpublic class CustomerPartial : FubuControl<Customer>\n\t{\n\t}\n\t\n\tpublic class OrderPartial : FubuControl<Order>\n\t{\n\t}\n\t\n\nIndexView.aspx: (standard html stuff trimmed)\n\n\t<div>\n\t    <%= this.PartialForEach(x => x.Customers).Using<CustomerPartial>() %>\n\t</div>\n\t\n\nCustomerPartial.ascx:\n\n\t<%@ Control Language=\"C#\" Inherits=\"FubuDemo.Controllers.Customers.CustomerPartial\" %>\n\t<div>\n\t    Customer\n\t    Name: <%= this.DisplayFor(x => x.Name) %> <br />    \n\t    Orders: (<%= Model.Orders.Count() %>) <br />\n\t\n\t    <%= this.PartialForEach(x => x.Orders).Using<OrderPartial>() %>\n\t</div>\n\t\n\nOrderPartial.ascx:\n\n\t<%@ Control Language=\"C#\" Inherits=\"FubuDemo.Controllers.Customers.OrderPartial\" %>\n\t<div>\n\t    Order <br />\n\t    Ref: <%= this.DisplayFor(x => x.Reference) %>\n\t</div>\n\t\n\nWhen I view Customers/Index, I see the following:\n\n\tCustomers \n\tCustomer Name: John Smith \n\tOrders: (1) \n\t\n\nIt seems that in CustomerPartial.ascx, doing Model.Orders.Count() correctly picks up that 1 order exists.  However PartialForEach(x => x.Orders) does not, as nothing is rendered for the order.  If I set a breakpoint on the Order constructor, I see that it initially gets called by the Index method on CustomersController, but then it gets called by FubuMVC.Core.Models.StandardModelBinder.Bind, so it is getting re-instantiated by FubuMVC and losing the content of the Orders collection.\n\nThis isn't quite what I'd expect, I would think that PartialForEach would just pass the domain object directly into the partial.  Am I missing the point somewhere?  What is the 'correct' way to achieve this kind of result in Fubu?\n\nUpdate:  In case it helps, this is the top few lines of the stacktrace the first time the Order constructor gets hit:\n\n\tat FubuDemo.Customer..ctor()\n\tat FubuDemo.Controllers.Customers.CustomersController.Index(IndexInputModel inputModel)\n\tat lambda_method(ExecutionScope , CustomersController , IndexInputModel )\n\tat FubuMVC.Core.Behaviors.OneInOneOutActionInvoker`3.performInvoke()\n\t\n\nAnd the second time:\n\n\tat FubuDemo.Customer..ctor()\n\tat System.RuntimeType.CreateInstanceImpl(Boolean publicOnly, Boolean skipVisibilityChecks, Boolean fillCache)\n\tat System.Activator.CreateInstance(Type type, Boolean nonPublic)\n\tat System.Activator.CreateInstance(Type type)\n\tat FubuMVC.Core.Models.StandardModelBinder.Bind(Type type, IBindingContext context)\n\tat FubuMVC.Core.Runtime.ObjectResolver.BindModel(Type type, IBindingContext context)\n\tat FubuMVC.Core.Runtime.ObjectResolver.BindModel(Type type, IRequestData data)\n\tat FubuMVC.Core.Diagnostics.RecordingObjectResolver.BindModel(Type type, IRequestData data)\n\tat FubuMVC.Core.Runtime.FubuRequest.<>c__DisplayClass2.<.ctor>b__0(Type type)\n\tat FubuMVC.Core.Util.Cache`2.Retrieve(KEY key)\n\tat FubuMVC.Core.Util.Cache`2.get_Item(KEY key)\n\tat FubuMVC.Core.Runtime.FubuRequest.Get[T]()\n\t",
  "lastActivityDate": "2014-03-18T00:20:45.183",
  "title": "Why is FubuMVC new()ing up my view model in PartialForEach?",
  "tags": [
    "fubumvc"
  ],
  "docScore": 0,
  "comments": [],
  "answers": [],
  "creationYearMonth": "201403",
  "itemTally": 0,
  "owner": null
}