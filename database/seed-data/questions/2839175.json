{
  "id": "/questions/2839175",
  "creationDate": "2014-05-17T14:36:53.383",
  "body": "\n\nI am trying to convert a SQL query to LINQ. Somehow my count(distinct(x)) logic does not seem to be working correctly. The original SQL is quite efficient(or so i think), but the generated SQL is not even returning the correct result.\n\nI am trying to fix this LINQ to do what the original SQL is doing, AND in an efficient way as the original query is doing. Help here would be really apreciated as I am stuck here :(\n\nSQL which is working and I need to make a comparable LINQ of:\n\n\tSELECT  [t1].[PersonID] AS [personid]\n\tFROM [dbo].[Code] AS [t0]\n\tINNER JOIN [dbo].[phonenumbers] AS [t1] ON [t1].[PhoneCode] = [t0].[Code]\n\tINNER JOIN [dbo].[person] ON [t1].[PersonID]= [dbo].[Person].PersonID\n\tWHERE ([t0].[codetype] = 'phone') AND (\n\t([t0].[CodeDescription] = 'Home') AND ([t1].[PhoneNum] = '111') \n\tOR\n\t([t0].[CodeDescription] = 'Work') AND ([t1].[PhoneNum] = '222') )\n\tGROUP BY [t1].[PersonID] HAVING COUNT(DISTINCT([t1].[PhoneNum]))=2\n\t\n\nThe LINQ which I made is approximately as below:\n\n\t var ids = context.Code.Where(predicate);\n\t            var rs = from r in ids\n\t                     group r by new { r.phonenumbers.person.PersonID} into g\n\t                     let matchcount=g.Select(p => p.phonenumbers.PhoneNum).Distinct().Count()\n\t                     where matchcount ==2\n\t                     select new\n\t                  {\n\t                      personid = g.Key\n\t                  };\n\t\n\nUnfortunately, the above LINQ is NOT generating the correct result, and is actually internally getting generated to the SQL shown below. By the way, this generated query is also reading ALL the rows(about 19592040) around 2 times due to the COUNTS :( Wich is a big performance issue too. Please help/point me to the right direction.\n\n\tDeclare @p0 VarChar(10)='phone'\n\tDeclare @p1 VarChar(10)='Home'\n\tDeclare @p2 VarChar(10)='111'\n\tDeclare @p3 VarChar(10)='Work'\n\tDeclare @p4 VarChar(10)='222'\n\tDeclare @p5 VarChar(10)='2'\n\t\n\tSELECT [t9].[PersonID], (\n\t    SELECT COUNT(*)\n\t    FROM (\n\t        SELECT DISTINCT [t13].[PhoneNum]\n\t        FROM [dbo].[Code] AS [t10]\n\t        INNER JOIN [dbo].[phonenumbers] AS [t11] ON [t11].[PhoneType] = [t10].[Code]\n\t        INNER JOIN [dbo].[Person] AS [t12] ON [t12].[PersonID] = [t11].[PersonID]\n\t        INNER JOIN [dbo].[phonenumbers] AS [t13] ON [t13].[PhoneType] = [t10].[Code]\n\t        WHERE ([t9].[PersonID] = [t12].[PersonID]) AND ([t10].[codetype] = @p0) AND ((([t10].[codetype] = @p1) AND ([t11].[PhoneNum] = @p2)) OR (([t10].[codetype] = @p3) AND ([t11].[PhoneNum] = @p4)))\n\t        ) AS [t14]\n\t    ) AS [cnt]\n\tFROM (\n\t    SELECT [t3].[PersonID], (\n\t        SELECT COUNT(*)\n\t        FROM (\n\t            SELECT DISTINCT [t7].[PhoneNum]\n\t            FROM [dbo].[Code] AS [t4]\n\t            INNER JOIN [dbo].[phonenumbers] AS [t5] ON [t5].[PhoneType] = [t4].[Code]\n\t            INNER JOIN [dbo].[Person] AS [t6] ON [t6].[PersonID] = [t5].[PersonID]\n\t            INNER JOIN [dbo].[phonenumbers] AS [t7] ON [t7].[PhoneType] = [t4].[Code]\n\t            WHERE ([t3].[PersonID] = [t6].[PersonID]) AND ([t4].[codetype] = @p0) AND ((([t4].[codetype] = @p1) AND ([t5].[PhoneNum] = @p2)) OR (([t4].[codetype] = @p3) AND ([t5].[PhoneNum] = @p4)))\n\t            ) AS [t8]\n\t        ) AS [value]\n\t    FROM (\n\t        SELECT [t2].[PersonID]\n\t        FROM [dbo].[Code] AS [t0]\n\t        INNER JOIN [dbo].[phonenumbers] AS [t1] ON [t1].[PhoneType] = [t0].[Code]\n\t        INNER JOIN [dbo].[Person] AS [t2] ON [t2].[PersonID] = [t1].[PersonID]\n\t        WHERE ([t0].[codetype] = @p0) AND ((([t0].[codetype] = @p1) AND ([t1].[PhoneNum] = @p2)) OR (([t0].[codetype] = @p3) AND ([t1].[PhoneNum] = @p4)))\n\t        GROUP BY [t2].[PersonID]\n\t        ) AS [t3]\n\t    ) AS [t9]\n\tWHERE [t9].[value] = @p5\n\t\n\nThanks!",
  "lastActivityDate": "2014-05-17T18:10:09.960",
  "title": "whats wrong in this LINQ synatx?",
  "tags": [
    "c#",
    "sql",
    "linq",
    "linq-to-sql"
  ],
  "docScore": 0,
  "comments": [],
  "answers": [],
  "creationYearMonth": "201405",
  "itemTally": 0,
  "owner": null
}