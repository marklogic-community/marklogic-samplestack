{
  "id": "/questions/2839899",
  "creationDate": "2014-05-17T19:22:43.313",
  "body": "\n\nI created a chat application and seems to work just fine except that it takes up 100% cpu. Can this loop take out 100% Cpu? If yes, then what do i do to overcome it?\n\n\t  @Override\n\t    public void run(){\n\t        try {\n\t            _objServerSocket = new ServerSocket(17001, 500);\n\t            while (true) {\n\t                try {\n\t\n\t                    initializeConnection();\n\t                    addNewChatClient();\n\t                    Thread.sleep(1000);\n\t\n\t                } catch (Exception ex) {\n\t                }\n\t            }\n\t        } catch (IOException ex) {\n\t          System.out.println(ex.getCause() + \"\\n\"+ ex.getMessage() + \"\\n\" + ex.getStackTrace());\n\t        }\n\t    }\n\t\n\nThanks in advance :)\n\nHi Bozho, Phil and Starkey.\nThis is the exception that i get.\n\n\tSEVERE: java.util.ConcurrentModificationException\n\t        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)\n\t        at java.util.AbstractList$Itr.next(AbstractList.java:343)\n\t        at misc.ChatRoom.cleanUpStreams(ChatRoom.java:34)\n\t        at misc.ChatServer.cleanUpStreams(ChatServer.java:85)\n\t        at common.Global.cleanupTasks(Global.java:81)\n\t        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\t        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\t        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\t        at java.lang.reflect.Method.invoke(Method.java:597)\n\t        at com.sun.ejb.containers.interceptors.BeanCallbackInterceptor.intercept(InterceptorManager.java:1006)\n\t        at com.sun.ejb.containers.interceptors.CallbackChainImpl.invokeNext(CallbackChainImpl.java:61)\n\t        at com.sun.ejb.containers.interceptors.CallbackInvocationContext.proceed(CallbackInvocationContext.java:109)\n\t        at com.sun.ejb.containers.interceptors.SystemInterceptorProxy.doCallback(SystemInterceptorProxy.java:133)\n\t        at com.sun.ejb.containers.interceptors.SystemInterceptorProxy.destroy(SystemInterceptorProxy.java:120)\n\t        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\t        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\t        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\t        at java.lang.reflect.Method.invoke(Method.java:597)\n\t        at com.sun.ejb.containers.interceptors.CallbackInterceptor.intercept(InterceptorManager.java:961)\n\t        at com.sun.ejb.containers.interceptors.CallbackChainImpl.invokeNext(CallbackChainImpl.java:61)\n\t        at com.sun.ejb.containers.interceptors.InterceptorManager.intercept(InterceptorManager.java:390)\n\t        at com.sun.ejb.containers.interceptors.InterceptorManager.intercept(InterceptorManager.java:373)\n\t        at com.sun.ejb.containers.AbstractSingletonContainer$SingletonContextFactory.destroy(AbstractSingletonContainer.java:727)\n\t        at com.sun.ejb.containers.AbstractSingletonContainer.doConcreteContainerShutdown(AbstractSingletonContainer.java:638)\n\t        at com.sun.ejb.containers.BaseContainer.onShutdown(BaseContainer.java:4111)\n\t        at org.glassfish.ejb.startup.SingletonLifeCycleManager.doShutdown(SingletonLifeCycleManager.java:166)\n\t        at org.glassfish.ejb.startup.EjbApplication.stop(EjbApplication.java:240)\n\t        at org.glassfish.internal.data.EngineRef.stop(EngineRef.java:165)\n\t        at org.glassfish.internal.data.ModuleInfo.stop(ModuleInfo.java:268)\n\t        at org.glassfish.internal.data.ApplicationInfo.stop(ApplicationInfo.java:251)\n\t        at com.sun.enterprise.v3.server.ApplicationLifecycle.unload(ApplicationLifecycle.java:759)\n\t        at com.sun.enterprise.v3.server.ApplicationLifecycle.undeploy(ApplicationLifecycle.java:790)\n\t        at org.glassfish.deployment.admin.UndeployCommand.execute(UndeployCommand.java:184)\n\t        at com.sun.enterprise.v3.admin.CommandRunnerImpl$1.execute(CommandRunnerImpl.java:305)\n\t        at com.sun.enterprise.v3.admin.CommandRunnerImpl.doCommand(CommandRunnerImpl.java:320)\n\t        at com.sun.enterprise.v3.admin.CommandRunnerImpl.doCommand(CommandRunnerImpl.java:1176)\n\t        at com.sun.enterprise.v3.admin.CommandRunnerImpl.access$900(CommandRunnerImpl.java:83)\n\t        at com.sun.enterprise.v3.admin.CommandRunnerImpl$ExecutionContext.execute(CommandRunnerImpl.java:1235)\n\t        at com.sun.enterprise.v3.admin.CommandRunnerImpl$ExecutionContext.execute(CommandRunnerImpl.java:1224)\n\t        at com.sun.enterprise.v3.admin.AdminAdapter.doCommand(AdminAdapter.java:365)\n\t        at com.sun.enterprise.v3.admin.AdminAdapter.service(AdminAdapter.java:204)\n\t        at com.sun.grizzly.tcp.http11.GrizzlyAdapter.service(GrizzlyAdapter.java:166)\n\t        at com.sun.enterprise.v3.server.HK2Dispatcher.dispath(HK2Dispatcher.java:100)\n\t        at com.sun.enterprise.v3.services.impl.ContainerMapper.service(ContainerMapper.java:245)\n\t        at com.sun.grizzly.http.ProcessorTask.invokeAdapter(ProcessorTask.java:791)\n\t        at com.sun.grizzly.http.ProcessorTask.doProcess(ProcessorTask.java:693)\n\t        at com.sun.grizzly.http.ProcessorTask.process(ProcessorTask.java:954)\n\t        at com.sun.grizzly.http.DefaultProtocolFilter.execute(DefaultProtocolFilter.java:170)\n\t        at com.sun.grizzly.DefaultProtocolChain.executeProtocolFilter(DefaultProtocolChain.java:135)\n\t        at com.sun.grizzly.DefaultProtocolChain.execute(DefaultProtocolChain.java:102)\n\t        at com.sun.grizzly.DefaultProtocolChain.execute(DefaultProtocolChain.java:88)\n\t        at com.sun.grizzly.http.HttpProtocolChain.execute(HttpProtocolChain.java:76)\n\t        at com.sun.grizzly.ProtocolChainContextTask.doCall(ProtocolChainContextTask.java:53)\n\t        at com.sun.grizzly.SelectionKeyContextTask.call(SelectionKeyContextTask.java:57)\n\t        at com.sun.grizzly.ContextTask.run(ContextTask.java:69)\n\t        at com.sun.grizzly.util.AbstractThreadPool$Worker.doWork(AbstractThreadPool.java:330)\n\t        at com.sun.grizzly.util.AbstractThreadPool$Worker.run(AbstractThreadPool.java:309)\n\t        at java.lang.Thread.run(Thread.java:619)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\tSEVERE: java.net.SocketException: Socket closed\n\t        at java.net.SocketInputStream.socketRead0(Native Method)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:129)\n\t        at java.net.SocketInputStream.read(SocketInputStream.java:182)\n\t        at java.io.ObjectInputStream$PeekInputStream.peek(ObjectInputStream.java:2249)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peek(ObjectInputStream.java:2542)\n\t        at java.io.ObjectInputStream$BlockDataInputStream.peekByte(ObjectInputStream.java:2552)\n\t        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1297)\n\t        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351)\n\t        at misc.ChatClient.run(ChatClient.java:71)\n\t\n\nAnd this exception continues endlessly as it is in loop. I would like to add that everything works fine. But this starts if some client is connected to serversocket and i again redeploy my application :d. I know you woulnt't want to do that, but still how should i avoid it? Should i remove the inner try catch? so that once any error comes it is directly thrown out of loop? But this doesn't seem practical. Does it? Since one client may face some problem connecting to the serversocket, does not mean that i should terminate my application only. Now can you all help me?\n\nThis is my whole ChatRoom class :-\n\n\tpackage misc;\n\t\n\timport java.io.IOException;\n\timport java.util.ArrayList;\n\t\n\tpublic class ChatRoom {\n\t     private ArrayList<ChatClient> _objChatMembers;\n\t     private int roomId = 0;\n\t\n\t     public ChatRoom(int roomId){\n\t         this.roomId = roomId;\n\t         this._objChatMembers = new ArrayList<ChatClient>();\n\t         System.out.println(\"Chat ROom created :\" + roomId);\n\t     }\n\t\n\t    public ArrayList<ChatClient> getObjChatMembers() {\n\t        return _objChatMembers;\n\t    }\n\t\n\t    public int getRoomId() {\n\t        return roomId;\n\t    }\n\t\n\t    public void setRoomId(int roomId) {\n\t        this.roomId = roomId;\n\t    }\n\t\n\t    public void setObjChatMembers(ArrayList<ChatClient> _objChatMembers) {\n\t        this._objChatMembers = _objChatMembers;\n\t    }\n\t\n\t     public void cleanUpStreams() throws IOException{\n\t        for(ChatClient objChatClient : _objChatMembers)\n\t            objChatClient.releaseStreams();\n\t    }\n\t\n\t}\n\t\n\nThis is my ChatServer's cleanupStreams:-\n\n\t//clean up streams\n\t    public void cleanUpStreams() throws IOException{\n\t        _objServerSocket.close();\n\t        for(ChatRoom objChatRoom : _objChatRooms)\n\t            objChatRoom.cleanUpStreams();\n\t    }\n\t\n\nThis is my Singleton bean which starts up as soon as application is deployed :-\n\n\tpackage common;\n\t\n\timport entity.UserProfile;\n\timport java.util.Date;\n\timport java.util.List;\n\timport javax.annotation.PostConstruct;\n\timport javax.annotation.PreDestroy;\n\timport javax.annotation.Resource;\n\timport javax.ejb.EJB;\n\timport javax.ejb.LocalBean;\n\timport javax.ejb.SessionContext;\n\timport javax.ejb.Singleton;\n\timport javax.ejb.Startup;\n\timport javax.ejb.Timeout;\n\timport javax.ejb.TimerService;\n\timport javax.persistence.EntityManager;\n\timport javax.persistence.PersistenceContext;\n\timport misc.ChatServer;\n\t\n\t@Startup\n\t@Singleton\n\t@LocalBean\n\tpublic class Global{\n\t\n\t    @EJB\n\t    private EmailManagerRemote _objEmailManager;\n\t\n\t    @EJB\n\t    private Utils _objUtils;\n\t\n\t    @Resource\n\t    private SessionContext _objSessionContext;\n\t\n\t    @PersistenceContext\n\t    private EntityManager _objEntityManager;\n\t\n\t    private TimerService _objTimerService;\n\t\n\t    private ChatServer _objChatServer;\n\t\n\t\n\t    @PostConstruct\n\t    public void init(){\n\t        final int TWENTY_FOUR_HOURS = 1000 * 60 * 60 * 24 ;\n\t        _objTimerService = _objSessionContext.getTimerService();\n\t        _objTimerService.createIntervalTimer(new Date(), TWENTY_FOUR_HOURS , null);\n\t\n\t        //start chat server\n\t        this._objChatServer = new ChatServer();\n\t        this._objChatServer.start();\n\t\n\t    }\n\t\n\t    @Timeout\n\t    public void sendBirthdayGreetingsAndBackupDatabase(){\n\t        //send birthday reminders\n\t        try{\n\t            List<UserProfile> userProfileList = _objEntityManager.createNamedQuery(\"UserProfile.findByBirthdate\").setParameter(\"birthdate\", new Date()).getResultList();\n\t            //List<UserProfile> userProfileList = _objEntityManager.createNamedQuery(\"UserProfile.findAll\").getResultList();\n\t\n\t            for(UserProfile objUserProfile : userProfileList)\n\t                _objEmailManager.sendMail(EMAIL_TEMPLATE_CONSTANTS.REGISTRATION,objUserProfile.getUser());\n\t        }\n\t        catch(Exception ex){\n\t            ex.printStackTrace();\n\t        }\n\t\n\t        //backup BMS database\n\t        try{\n\t            _objUtils.backupBMSDB();\n\t        }\n\t        catch(Exception ex){\n\t\n\t        }\n\t    }\n\t\n\t    @PreDestroy\n\t    public void cleanupTasks(){\n\t         try{\n\t            if(_objChatServer != null)\n\t                _objChatServer.cleanUpStreams();\n\t        }\n\t        catch(Exception ex){\n\t            ex.printStackTrace();\n\t        }\n\t    }\n\t\n\t}\n\t\n\nPlease ask me if anything else too is needed.\n\nThis is my ChatClient's releaseStreams :-\n\n\t  public void releaseStreams() throws IOException {\n\t        multicastData(_objChatUser);\n\t        this._objChatRoom.getObjChatMembers().remove(this);\n\t\n\t        _objObjectOutputStream.close();\n\t        _objObjectInputStream.close();\n\t        _clientSocket.close();\n\t    }\n\t",
  "lastActivityDate": "2014-05-17T20:02:33.573",
  "title": "Can this loop take out 100% CPU?",
  "tags": [
    "java",
    "sockets"
  ],
  "docScore": 0,
  "comments": [],
  "answers": [],
  "creationYearMonth": "201405",
  "itemTally": 0,
  "owner": null
}